package aeac.sys.aeac_basetemple.utils;

import kd.bos.context.RequestContext;
import kd.bos.dataentity.entity.DynamicObject;
import kd.bos.dataentity.entity.DynamicObjectCollection;
import kd.bos.dataentity.entity.LocaleString;
import kd.bos.ext.form.control.CustomControl;
import kd.bos.fileservice.FileService;
import kd.bos.fileservice.FileServiceFactory;
import kd.bos.form.FormShowParameter;
import kd.bos.form.ShowType;
import kd.bos.form.control.AttachBtnOption;
import kd.bos.form.control.AttachmentPanel;
import kd.bos.form.control.Control;
import kd.bos.form.control.events.AttachmentOperaClickEvent;
import kd.bos.form.control.events.AttachmentOperaClickListener;
import kd.bos.form.field.AttachmentEdit;
import kd.bos.form.plugin.AbstractFormPlugin;
import kd.bos.orm.query.QCP;
import kd.bos.orm.query.QFilter;
import kd.bos.servicehelper.QueryServiceHelper;
import kd.bos.session.EncreptSessionUtils;
import kd.bos.url.UrlService;
import kd.bos.util.FileNameUtils;
import kd.bos.util.StringUtils;
import org.apache.commons.lang3.ArrayUtils;

import java.util.*;

public class UploadFileFormPlugin extends AbstractFormPlugin implements AttachmentOperaClickListener {
    private static final String KEY_ATTACHMENTPENAL = "attachmentfield";

    @Override
    public void registerListener(EventObject e) {
        AttachmentEdit panel = this.getControl(KEY_ATTACHMENTPENAL);
        panel.addOperaClickListener(this);;
    }

    @Override
    public void afterCreateNewData(EventObject e) {
        super.afterCreateNewData(e);
        AttachmentEdit panel = this.getControl(KEY_ATTACHMENTPENAL);

        List<AttachBtnOption> btns = new ArrayList<AttachBtnOption>();
        panel.getAttachmentModel();
        btns.add(new AttachBtnOption("shusheng_preview", new LocaleString("书生预览")));
        btns.add(new AttachBtnOption("wps_preview", new LocaleString("wps预览")));

        panel.addAttachOperaBtn(btns);
    }

    @Override
    public void attachmentOperaClick(AttachmentOperaClickEvent e) {
        /**控件面板
        List<Map<String, Object>> atts = panel.getAttachmentData();
        Map<String, Object> att = null;
        for (Map<String, Object> map : atts) {
            String uid = (String) map.get("uid");
            if (uid.equals(attinfo.get("uid"))) {
                att = map;
                continue;
            }
        }
        if ("attoption_1".contentEquals(e.getOperaKey())) {
            System.out.println("分享附件："+att.get("name")+att.get("url"));
        }*/

        //控件字段
        AttachmentEdit panel = (AttachmentEdit) e.getSource();
        Map<String, String> attinfo = (Map<String, String>) e.getAttachmentInfo();
        DynamicObject query = QueryServiceHelper.queryOne("bd_attachment","url", new QFilter[]{new QFilter("uid", QCP.equals, attinfo.get("uid"))});
        String url = query.getString("url");
        if ("shusheng_preview".contentEquals(e.getOperaKey())) {
            String attachmentFullUrl = UrlService.getAttachmentFullUrl(url);
            String path = EncreptSessionUtils.encryptSession(attachmentFullUrl);
            FormShowParameter parameter = new FormShowParameter();
            parameter.setFormId("aeac_shusheng");
            parameter.setCaption("书生阅读器");
            parameter.setCustomParam("filepath",path);
            parameter.getOpenStyle().setTargetKey("tabap");
            parameter.getOpenStyle().setShowType(ShowType.MainNewTabPage);
            this.getView().showForm(parameter);
        }else if ("wps_preview".contentEquals(e.getOperaKey())){
            this.openDoc("openFile",url,"123.doc");
        }
    }

    private void openExcel(String excel) {
        CustomControl customcontrol = this.getView().getControl("aeac_customcontrolap");
        Map<String, String> data = new HashMap<>();
        String path = "/cosmic-simple/679008189806542848/202203/edge_sup/edge_wpsbill/1377684016538322944/attachments/8fc3f70366344a589789d142f859d748/宋海鑫市内交通费.xlsx";
        data.put("LOD_action", "openExcel");
        data.put("updata", UUID.randomUUID().toString());
        data.put("filePath", path);
        customcontrol.setData(data);
    }

    private void openDoc(String method, String path, String fileName) {
//        long wpsId = (long) this.getModel().getValue("aeac_wpsid");
//        String edgeTitle = (String) this.getModel().getValue("aeac_title");
//        String fileName = edgeTitle + ".doc";
//        if (StringUtils.isEmpty(edgeTitle)) {
//            this.getView().showTipNotification(new LocaleString("请输入发文标题").toString());
//            return;
//        }

//            String tenantId = RequestContext.get().getTenantId();
//            String accountId = RequestContext.get().getAccountId();
//            String path = FileNameUtils.getAttachmentFileName(tenantId, accountId, wpsId, fileName);
            FileService service = FileServiceFactory.getAttachmentFileService();
            boolean exists = service.exists(path);


            CustomControl customcontrol = this.getView().getControl("aeac_customcontrolap");
            Map<String, String> data = new HashMap<>();
            if (exists) {
                data.put("LOD_action", method);
                if ("tht".equals(method)) {
                    data.put("tempUrl", "/zhf/1355813106848104448/202203/aeac_modeldemo/aeac_modeldemo/1370901714193879040/attachments/60e937dde050418b8b9cd51ba7345545/东蓝红头文件.docx");
                }
            } else {
                data.put("LOD_action", "newFile");
            }
            // updata无实际意义，只为可以刷新数据
            data.put("updata", UUID.randomUUID().toString());
            data.put("filePath", path);
            data.put("fileName", fileName);
            customcontrol.setData(data);
            //
    }
}
