package aeac.sys.aeac_basetemple.utils;

import kd.bos.dataentity.entity.DynamicObject;
import kd.bos.dataentity.entity.DynamicObjectCollection;
import kd.bos.dataentity.entity.LocaleString;
import kd.bos.form.FormShowParameter;
import kd.bos.form.ShowType;
import kd.bos.form.control.AttachBtnOption;
import kd.bos.form.control.AttachmentPanel;
import kd.bos.form.control.Control;
import kd.bos.form.control.events.AttachmentOperaClickEvent;
import kd.bos.form.control.events.AttachmentOperaClickListener;
import kd.bos.form.field.AttachmentEdit;
import kd.bos.form.plugin.AbstractFormPlugin;
import kd.bos.orm.query.QCP;
import kd.bos.orm.query.QFilter;
import kd.bos.servicehelper.QueryServiceHelper;
import kd.bos.session.EncreptSessionUtils;
import kd.bos.url.UrlService;
import org.apache.commons.lang3.ArrayUtils;

import java.util.*;

public class UploadFileFormPlugin extends AbstractFormPlugin implements AttachmentOperaClickListener {
    private static final String KEY_ATTACHMENTPENAL = "attachmentfield";

    @Override
    public void registerListener(EventObject e) {
        AttachmentEdit panel = this.getControl(KEY_ATTACHMENTPENAL);
        panel.addOperaClickListener(this);;
    }

    @Override
    public void afterCreateNewData(EventObject e) {
        super.afterCreateNewData(e);
        AttachmentEdit panel = this.getControl(KEY_ATTACHMENTPENAL);

        List<AttachBtnOption> btns = new ArrayList<AttachBtnOption>();
        panel.getAttachmentModel();
        btns.add(new AttachBtnOption("shusheng_preview", new LocaleString("书生预览")));
        btns.add(new AttachBtnOption("wps_preview", new LocaleString("wps预览")));

        panel.addAttachOperaBtn(btns);
    }

    @Override
    public void attachmentOperaClick(AttachmentOperaClickEvent e) {
        /**控件面板
        List<Map<String, Object>> atts = panel.getAttachmentData();
        Map<String, Object> att = null;
        for (Map<String, Object> map : atts) {
            String uid = (String) map.get("uid");
            if (uid.equals(attinfo.get("uid"))) {
                att = map;
                continue;
            }
        }
        if ("attoption_1".contentEquals(e.getOperaKey())) {
            System.out.println("分享附件："+att.get("name")+att.get("url"));
        }*/

        //控件字段
        AttachmentEdit panel = (AttachmentEdit) e.getSource();
        Map<String, String> attinfo = (Map<String, String>) e.getAttachmentInfo();
        DynamicObject query = QueryServiceHelper.queryOne("bd_attachment","url", new QFilter[]{new QFilter("uid", QCP.equals, attinfo.get("uid"))});
        String url = query.getString("url");
        String attachmentFullUrl = UrlService.getAttachmentFullUrl(url);
        String path = EncreptSessionUtils.encryptSession(attachmentFullUrl);
        if ("shusheng_preview".contentEquals(e.getOperaKey())) {
            FormShowParameter parameter = new FormShowParameter();
            parameter.setFormId("aeac_shusheng");
            parameter.setCaption("书生阅读器");
            parameter.setCustomParam("filepath",path);
            parameter.getOpenStyle().setTargetKey("tabap");
            parameter.getOpenStyle().setShowType(ShowType.MainNewTabPage);
            this.getView().showForm(parameter);
        }else if ("wps_preview".contentEquals(e.getOperaKey())){

        }
    }
}
